<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MindAR — Video over Image (calibrated)</title>

  <!-- MindAR + A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body{margin:0;overflow:hidden;font-family:system-ui,Roboto}
    #ui{position:fixed;left:10px;top:10px;z-index:9999;background:rgba(0,0,0,0.6);color:#fff;padding:10px;border-radius:8px}
    #ui input{width:70px}
    #status{margin-top:6px;color:#ffd}
    button{margin-top:6px}
  </style>
</head>
<body>
  <div id="ui">
    Printed width (cm): <input id="printWidth" type="number" value="20" step="0.1">
    <button id="apply">Apply</button>
    <div><button id="tap">Tap to start (if needed)</button></div>
    <div id="status">Ready — point camera at target</div>
  </div>

  <!-- Video kept renderable (tiny & transparent) -->
  <video id="video" src="video.mp4" preload="auto" playsinline webkit-playsinline crossorigin="anonymous" loop muted style="position:absolute;left:0;top:0;width:2px;height:2px;opacity:0.001"></video>

  <!-- MindAR A-Frame scene -->
  <a-scene mindar-image="imageTargetSrc: ./targets.mind; autoStart: false;" embedded color-space="sRGB">
    <a-assets>
      <!-- ensure A-Frame knows about the video -->
      <video id="af-video" src="video.mp4" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
    </a-assets>

    <!-- anchor 0 is the first target in targets.mind -->
    <a-entity mindar-image-target="targetIndex: 0">
      <!-- plane is centered on the target; width/height will be set by JS to match printed size -->
      <a-plane id="video-plane" position="0 0 0" rotation="-90 0 0" material="shader: flat; src: #af-video; side: double" visible="false"></a-plane>
    </a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    (function(){
      const printInput = document.getElementById('printWidth');
      const applyBtn = document.getElementById('apply');
      const status = document.getElementById('status');
      const tap = document.getElementById('tap');
      const video = document.getElementById('af-video'); // A-Frame asset video
      const plane = document.getElementById('video-plane');
      const mindarComponent = document.querySelector('a-scene').components['mindar-image'];

      // Autoplay friendliness: keep muted; provide tap fallback
      document.getElementById('tap').addEventListener('click', ()=> {
        video.play().catch(()=>{});
        document.body.focus();
      });

      // Auto-size plane when metadata available
      video.addEventListener('loadedmetadata', () => {
        status.textContent = 'Video metadata loaded. Click Apply after setting printed width (cm).';
      });

      // Apply printed width (cm -> meters). Use video aspect ratio to set height.
      function applyPrintedWidth(cm) {
        const meters = Number(cm) / 100;
        const aspect = (video.videoWidth && video.videoHeight) ? (video.videoWidth / video.videoHeight) : (16/9);
        const height = meters / aspect;
        plane.setAttribute('width', meters);
        plane.setAttribute('height', height);
        status.textContent = `Plane set to ${meters.toFixed(3)} m × ${height.toFixed(3)} m`;
      }

      applyBtn.addEventListener('click', ()=> {
        const cm = parseFloat(printInput.value);
        if (!cm || cm <= 0) { status.textContent = 'Enter valid printed width (cm)'; return; }
        applyPrintedWidth(cm);
      });

      // Start MindAR when user taps permission dialogs (autoStart false -> we start manually)
      const scene = document.querySelector('a-scene');
      scene.addEventListener('renderstart', ()=> status.textContent='Camera started, point at target');

      // Start MindAR on first user gesture or immediately if allowed
      function startMindAR() {
        if (scene.systems['mindar-image'].isStarted) return;
        scene.systems['mindar-image'].start().then(()=> {
          status.textContent = 'MindAR started — looking for target';
        }).catch(e => { console.error(e); status.textContent = 'MindAR start failed: ' + e; });
      }

      // Start on a user tap (helps with autoplay/policy)
      document.body.addEventListener('click', startMindAR, { once: true });

      // Play/pause video on target found/lost
      const anchor = document.querySelector('[mindar-image-target]');
      anchor.addEventListener('targetFound', async () => {
        plane.setAttribute('visible','true');
        try { await video.play(); } catch(e) { console.warn('autoplay blocked', e); }
        status.textContent = 'Target found — playing';
      });
      anchor.addEventListener('targetLost', () => {
        plane.setAttribute('visible','false');
        try { video.pause(); video.currentTime = 0; } catch(e) {}
        status.textContent = 'Target lost';
      });

      // helpful: start MindAR automatically if user previously tapped
      // and auto-size plane if user set printed width before metadata loaded
      video.addEventListener('canplay', ()=> {
        const cm = parseFloat(printInput.value);
        if (cm > 0) applyPrintedWidth(cm);
      });
    })();
  </script>
</body>
</html>
