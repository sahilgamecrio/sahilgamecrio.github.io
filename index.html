<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>AR NFT — Video on Image (fixed)</title>

  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family:system-ui,Segoe UI,Roboto; }
    #ui { position:absolute; z-index:9999; left:12px; top:12px; background:rgba(0,0,0,0.6); color:#fff; padding:10px; border-radius:8px; }
    #tap { display:none; margin-top:8px; background:#fff;color:#000;padding:8px 10px;border-radius:6px;border:none; cursor:pointer;}
    #log { font-size:0.85rem; margin-top:6px; color:#ffd; max-width:340px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div id="ui">
    <div id="status">Ready — point camera at target</div>
    <button id="tap">Tap to Start Video</button>
    <div id="log"></div>
  </div>

  <!-- IMPORTANT: do NOT use display:none — keep it in DOM and renderable (tiny/transparent) -->
  <video id="ar-video"
         src="./video.mp4"
         preload="auto"
         loop
         muted
         playsinline
         webkit-playsinline
         crossorigin="anonymous"
         style="position:absolute; left:0; top:0; width:1px; height:1px; opacity:0;"
  ></video>

  <a-scene vr-mode-ui="enabled:false" embedded renderer="logarithmicDepthBuffer:true"
           arjs="trackingMethod:best; sourceType:webcam; debugUIEnabled:false;">
    <a-nft id="my-nft" type="nft" url="https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/trex-image/trex" smooth="true">
      <a-plane id="video-plane" rotation="-90 0 0" width="1.6" height="0.9" material="shader: flat; src: #ar-video;" visible="false"></a-plane>
    </a-nft>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
  (function(){
    const status = id => document.getElementById('status').textContent = id;
    const logEl = document.getElementById('log');
    const tapBtn = document.getElementById('tap');
    const video = document.getElementById('ar-video');
    const plane = document.getElementById('video-plane');
    const nft = document.getElementById('my-nft');

    function dbg(...args){
      console.log('[AR-DBG]', ...args);
      logEl.textContent = (logEl.textContent + '\n' + args.join(' ')).slice(-2000);
    }

    video.crossOrigin = 'anonymous';
    video.muted = true;
    try { video.load(); } catch(e) { dbg('video.load() failed', e); }

    video.addEventListener('loadedmetadata', () => {
      dbg('loadedmetadata', video.videoWidth, video.videoHeight);
      if (video.videoWidth && video.videoHeight) {
        const aspect = video.videoWidth / video.videoHeight;
        const width = 1.6;
        plane.setAttribute('width', width);
        plane.setAttribute('height', width / aspect);
        dbg('plane sized to', (width / aspect).toFixed(3));
      }
    });

    video.addEventListener('canplay', () => dbg('canplay fired — video can render a frame'));

    video.addEventListener('error', (ev) => {
      dbg('video error event', ev);
      status('Video load error — check console/network');
    });

    async function tryPlay(){
      try {
        const p = video.play();
        if (p !== undefined) await p;
        dbg('video.play() resolved — playing');
        return true;
      } catch (err) {
        dbg('video.play() rejected:', err);
        return false;
      }
    }

    nft.addEventListener('markerFound', async () => {
      dbg('markerFound — showing plane and trying to play');
      plane.setAttribute('visible','true');
      status('Marker found — playing video...');
      const ok = await tryPlay();
      if (!ok) {
        dbg('Autoplay blocked — showing tap button');
        tapBtn.style.display = 'inline-block';
        status('Tap to start video (autoplay blocked)');
      } else {
        tapBtn.style.display = 'none';
      }
    });

    nft.addEventListener('markerLost', () => {
      dbg('markerLost — hiding plane & pause');
      plane.setAttribute('visible','false');
      video.pause();
      video.currentTime = 0;
      status('Marker lost');
    });

    // fallback global events (some versions bubble marker events)
    document.addEventListener('markerFound', () => { plane.setAttribute('visible','true'); tryPlay(); });
    document.addEventListener('markerLost', () => { plane.setAttribute('visible','false'); video.pause(); video.currentTime = 0; });

    // user gesture fallback
    tapBtn.addEventListener('click', async () => {
      dbg('tap button clicked — trying play');
      const ok = await tryPlay();
      if (ok) { tapBtn.style.display = 'none'; status('Playing'); }
    });
    document.body.addEventListener('click', () => {/* one click helps many browsers */}, { once:true });

    dbg('script initialized — video.src=', video.src);
  })();
  </script>
</body>
</html>
