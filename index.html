<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0"/>
  <title>Testing  marker</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- AR.js via raw.githack (less likely to be blocked) -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    .hint { position: fixed; left: 8px; top: 8px; color: white; font-family: Arial, sans-serif; z-index: 9999; background: rgba(0,0,0,0.5); padding:6px 8px; border-radius:6px; }
    #manual-play { position: fixed; left:50%; top:50%; transform: translate(-50%,-50%); z-index:99999; padding:12px 18px; border-radius:8px; border:none; background:#fff; color:#000; font-weight:600; display:none; }
  </style>
</head>
<body>
  <div class="hint">Point your camera at the printed marker. Allow camera permission. (Use poster/print/second screen)</div>

  <!-- Video: muted so mobile allows autoplay. Put a poster image if you want a still while loading -->
  <video id="ar-video" playsinline webkit-playsinline muted preload="auto" loop crossorigin="anonymous" style="display:none;" poster="poster.jpg">
    <source src="video.mp4" type="video/mp4">
  </video>

  <button id="manual-play">Tap to start video</button>

  <a-scene embedded vr-mode-ui="enabled: false"
         renderer="antialias: true; logarithmicDepthBuffer: true;"
         arjs="sourceType: webcam; debugUIEnabled: false; maxDetectionRate: 30;">

  <!-- Use a high-quality local .patt or the default hiro for testing -->
  <a-marker type="pattern" url="./mytarget.patt" id="marker">
    <a-plane id="video-plane" position="0 0 0" rotation="-90 0 0" width="1" height="0.5625"
             material="shader: flat; src: #ar-video; transparent: true;"></a-plane>
  </a-marker>
  <a-entity camera></a-entity>
</a-scene>

<script>
(async function(){
  const log = (...a)=>console.log('[AR DEBUG]',...a);
  const warn = (...a)=>console.warn('[AR DEBUG]',...a);
  const err = (...a)=>console.error('[AR DEBUG]',...a);

  // Basic element checks
  const scene = document.querySelector('a-scene');
  if (!scene) return err('No <a-scene> found');
  const marker = document.getElementById('marker');
  const video = document.getElementById('ar-video');

  // Asset HEAD checks
  async function headCheck(url,name){
    if (!url) return warn('No URL for',name);
    try {
      const r = await fetch(url,{method:'HEAD'});
      if (!r.ok) err(`${name} HEAD returned ${r.status}:`, url);
      else log(`${name} reachable:`, url);
    } catch(e){ err(`${name} fetch HEAD failed:`, url, e); }
  }

  // Wait scene load
  scene.addEventListener('loaded', async ()=>{
    log('A-Frame scene loaded');

    // Check AR.js loaded
    if (typeof AR === 'undefined' && typeof THREEx === 'undefined') {
      warn('AR.js global not detected (but sometimes OK). Check Network if aframe-ar.js loaded.');
    } else log('AR.js appears present');

    // patt check
    const pattUrl = marker ? marker.getAttribute('url') : null;
    await headCheck(pattUrl,'marker pattern');

    // video check
    if (video) {
      const s = video.querySelector('source');
      await headCheck(s ? s.getAttribute('src') : null, 'video file');
    } else warn('No video element (id=ar-video) found');

    // Camera probe
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({video:true})
      .then(stream => { stream.getTracks().forEach(t=>t.stop()); log('Camera permission OK'); })
      .catch(e => err('Camera permission test failed:', e));
    } else err('getUserMedia not supported');

    // Marker event logging
    if (marker) {
      marker.addEventListener('markerFound', ()=>log('EVENT markerFound'));
      marker.addEventListener('markerLost', ()=>log('EVENT markerLost'));
    } else warn('marker element missing');
  });

  // If page is in iframe, show open-in-new-tab button (iframe can block camera)
  try {
    if (window.self !== window.top) {
      const btn = document.createElement('button');
      btn.textContent = 'Open full page';
      Object.assign(btn.style,{position:'fixed',right:12,top:12,zIndex:99999,padding:'8px 12px'});
      btn.onclick = ()=> window.open(window.location.href.split('?')[0]+'?fullscreen=1','_blank');
      document.body.appendChild(btn);
      warn('Page in iframe â€” camera may be blocked. Use "Open full page".');
    }
  } catch(e){/* ignored */ }

})();
</script>


</body>
</html>
